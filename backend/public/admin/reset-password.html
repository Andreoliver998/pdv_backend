<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Redefinir senha (Admin)</title>
  <link rel="icon" href="./asset/pay-2.png" />

  <link rel="stylesheet" href="./theme.css" />
  <link rel="stylesheet" href="./admin.css" />
</head>

<body>
  <div class="wrap">
    <div class="top">
      <h1 class="title">Portal do SuperDono</h1>
    </div>

    <div class="card">
      <h2 style="margin: 0 0 10px 0">Redefinir senha</h2>
      <p class="hint" style="margin: 0 0 12px 0">Defina uma nova senha para sua conta admin.</p>

      <div class="row" style="align-items: flex-end">
        <label>
          <span>Nova senha</span>
          <input id="newPassword" type="password" minlength="6" autocomplete="new-password" placeholder="mín. 6 caracteres" />
        </label>

        <label>
          <span>Confirmar</span>
          <input id="confirmPassword" type="password" minlength="6" autocomplete="new-password" placeholder="repita a senha" />
        </label>

        <div style="display: flex; gap: 10px">
          <button id="resetBtn" class="btn-primary" type="button">Redefinir</button>
          <a class="btn-outline" href="./" style="text-decoration: none; display: inline-flex; align-items: center">Voltar</a>
        </div>
      </div>

      <div id="msg" class="hint"></div>
    </div>
  </div>

  <script src="./config.js"></script>
  <script>
    window.__APP_CONFIG__ = window.__APP_CONFIG__ || {};
    window.__APP_CONFIG__.API_BASE_URL = "/api";

    function resolveApiBase() {
      const raw = String(window.__APP_CONFIG__?.API_BASE_URL ?? "").trim().replace(/\/$/, "");
      if (!raw) return "/api";
      if (raw.startsWith("/")) return raw;
      try {
        const url = new URL(raw);
        if (!url.pathname || url.pathname === "/") url.pathname = "/api";
        return url.toString().replace(/\/$/, "");
      } catch {
        return raw;
      }
    }

    const API_BASE = resolveApiBase();

    function setMsg(text) {
      const el = document.getElementById("msg");
      if (el) el.textContent = String(text || "");
    }

    const token = new URLSearchParams(window.location.search).get("token") || "";
    if (!token) setMsg("Token ausente. Solicite um novo link.");

    document.getElementById("resetBtn").addEventListener("click", async () => {
      setMsg("");
      const p1 = String(document.getElementById("newPassword").value || "");
      const p2 = String(document.getElementById("confirmPassword").value || "");

      if (!token) return setMsg("Token ausente. Solicite um novo link.");
      if (p1.length < 6) return setMsg("A senha deve ter pelo menos 6 caracteres.");
      if (p1 !== p2) return setMsg("As senhas não conferem.");

      document.getElementById("resetBtn").disabled = true;
      setMsg("Redefinindo...");

      try {
        const res = await fetch(`${API_BASE}/admin/auth/reset-password`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, newPassword: p1 }),
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);

        setMsg(data.message || "Senha atualizada com sucesso.");
        setTimeout(() => {
          window.location.href = "./";
        }, 900);
      } catch (err) {
        setMsg(String(err?.message || "Erro ao redefinir."));
        document.getElementById("resetBtn").disabled = false;
      }
    });
  </script>
</body>
</html>
