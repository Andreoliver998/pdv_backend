<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="color-scheme" content="light dark" />
    <title>Redefinir senha</title>
    <link rel="icon" href="./asset/favicon_pay.png" />
    <link rel="stylesheet" href="styles.css" />
    <meta name="theme-color" content="#0b1220" />
  </head>

  <body>
    <div class="login-box" role="region" aria-label="Redefinir senha">
      <div class="login-card" role="dialog" aria-modal="true" aria-labelledby="resetTitle">
        <div class="brand">
          <div class="brand-mark" aria-hidden="true">PDV</div>
          <div class="brand-text">
            <h2 id="resetTitle">Redefinir senha</h2>
            <p class="hint" style="margin: 2px 0 0">
              Informe a nova senha. O link expira em 30 minutos.
            </p>
          </div>
        </div>

        <form id="resetForm" class="form" autocomplete="off" novalidate>
          <label class="field" for="newPassword">
            <span>Nova senha</span>
            <input id="newPassword" type="password" minlength="6" required />
          </label>

          <label class="field" for="confirmPassword">
            <span>Confirmar nova senha</span>
            <input id="confirmPassword" type="password" minlength="6" required />
          </label>

          <button id="resetBtn" type="submit" class="btn-primary full">Redefinir</button>
          <p id="resetMsg" class="hint" role="status" aria-live="polite"></p>
        </form>
      </div>
    </div>

    <script src="config.js"></script>
    <script src="js/maintenance-banner.js"></script>
    <script>
      function computeApiBase() {
        const raw = String(window.__APP_CONFIG__?.API_BASE_URL || "")
          .trim()
          .replace(/\/$/, "");

        if (!raw) return "/api";
        if (raw.startsWith("/")) return raw;

        try {
          const url = new URL(raw);
          if (!url.pathname || url.pathname === "/") url.pathname = "/api";
          return url.toString().replace(/\/$/, "");
        } catch {
          return raw;
        }
      }

      const API_BASE = computeApiBase();

      function setMsg(text) {
        const el = document.getElementById("resetMsg");
        if (el) el.textContent = text || "";
      }

      const token = new URLSearchParams(window.location.search).get("token") || "";
      if (!token) {
        setMsg('Token ausente. Solicite um novo link em "Esqueci minha senha".');
        document.getElementById("resetBtn").disabled = true;
      }

      document.getElementById("resetForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const password = document.getElementById("newPassword").value || "";
        const confirm = document.getElementById("confirmPassword").value || "";

        if (password.length < 6) return setMsg("A senha deve ter pelo menos 6 caracteres.");
        if (password !== confirm) return setMsg("As senhas nao conferem.");

        document.getElementById("resetBtn").disabled = true;
        setMsg("Redefinindo senha...");

        try {
          const res = await fetch(`${API_BASE}/auth/reset-password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, password }),
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);

          setMsg(data.message || "Senha redefinida com sucesso.");
          setTimeout(() => {
            window.location.href = "index.html";
          }, 800);
        } catch (err) {
          setMsg(String(err?.message || "Ocorreu um erro."));
          document.getElementById("resetBtn").disabled = false;
        }
      });
    </script>
  </body>
</html>
